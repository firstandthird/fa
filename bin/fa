#!/bin/bash

VERSION="0.1.0"
REPO=git://github.com/firstandthird/fa.git
TYPE=d
ROOT="."
QUERY=""
EXEC=""
DEPTH=3
LIST=0
APP=$0
RESULTS=""


usage() {
  cat <<-EOF

  Usage: fa [options]

  Options:

    -V, --version               output program version
    --update                    update browser-updater to latest version 
    -h, --help                  output help information


EOF
}

init() {
  cat <<-EOF
alias fa=". $APP"
alias fd=". $APP -d"
alias ff=". $APP -f"
alias fv=". $APP -f -e vim"
EOF
}

search() {
  if [ -z "$QUERY" ]; then
    echo "Please pass in a search query"
  else
    unset i RESULTS
    while IFS= read -r -d $'\0' file; do
      RESULTS[i++]="$file"
    done < <(find $ROOT -type $TYPE -depth -$DEPTH -name "*$QUERY*" -print0)
  fi
}

run() {
  search

  if [ "$LIST" = 1 ]; then
    unset i
    for i in "${RESULTS[@]}"; do
      echo $i
    done
    return
  fi

  if [ -n "$EXEC" ]; then
    eval "$EXEC ${RESULTS[0]}"
    return
  fi

  case $TYPE in
    d)
      pushd ${RESULTS[0]}
      ;;
    f)
      echo ${RESULTS[0]}
      ;;
  esac
}

while test $# -ne 0; do
  arg=$1
  shift
  case $arg in
    -h|--help)
      usage
      exit
      ;;
    -V|--version)
      echo $VERSION
      exit
      ;;
    --init)
      init
      exit
      ;;
    -r|--root)
      ROOT=$1
      shift
      ;;
    -d|--dir)
      TYPE=d
      ;;
    -f|--file)
      TYPE=f
      ;;
    --depth)
      DEPTH=$1
      shift
      ;;
    -l|--ls)
      LIST=1
      ;;
    -e|--exec)
      EXEC=$1
      shift
      ;;
    *)
      QUERY=$arg
      ;;
  esac
done

run
